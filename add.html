---
---
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>{{ site.title }} — Add Deadline</title>
    <meta name="description" content="Add your own deadlines locally in your browser.">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="{{ "/static/css/deadlines.css" | prepend:site.baseurl }}" media="screen,projection">
    <link rel="shortcut icon" href="{{ "/static/img/favicon.png" | prepend:site.baseurl }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="{{ "/static/js/store.min.js" | prepend:site.baseurl }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>
  <body>
    <div class="top-strip"></div>
    <div class="container">
      <div class="page-header">
        <h1>
          Add a Deadline
          <small><a href="{{ site.baseurl }}/">Back to deadlines</a></small>
        </h1>
        <div class="clearfix" style="margin-top:10px">
          <div id="auth-status" class="pull-right"></div>
        </div>
        <p>Entries are stored only in your browser using local storage. Clearing site data will remove them.</p>
      </div>

      <div class="row">
        <div class="col-sm-8">
          <form id="deadline-form">
            <div class="form-group">
              <label for="name">Name</label>
              <input id="name" type="text" class="form-control" placeholder="e.g., My Project Milestone" required>
            </div>
            <div class="form-group">
              <label for="details">Details (optional)</label>
              <textarea id="details" class="form-control" rows="3" placeholder="Short description or link"></textarea>
            </div>
            <div class="form-group">
              <label for="datetime">Deadline date and time</label>
              <input id="datetime" type="datetime-local" class="form-control" required>
              <p class="help-block">Uses your local timezone. It will display accordingly on the homepage.</p>
            </div>
            <div class="form-group">
              <label for="tags">Tags (comma-separated)</label>
              <input id="tags" type="text" class="form-control" placeholder="e.g., SEC, PRIV, CONF">
              <p class="help-block">Known tags: {% for type in site.data.types %}<code>{{ type.tag }}</code>{% unless forloop.last %}, {% endunless %}{% endfor %}</p>
            </div>
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" id="clear-all" class="btn btn-link pull-right">Clear all my saved deadlines</button>
          </form>
        </div>
      </div>

      <hr>
      <div class="row">
        <div class="col-sm-12">
          <h3>My saved deadlines</h3>
          <div id="saved-empty" class="text-muted" style="display:none">No saved deadlines yet.</div>
          <div class="table-responsive">
            <table class="table table-striped" id="saved-table" style="display:none">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Details</th>
                  <th>When</th>
                  <th>Tags</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function(){
        var storageKey = '{{ site.domain }}:custom_deadlines';
        var authToken = null;

        function setAuthUI(email){
          var $as = $('#auth-status');
          if (email) {
            $as.html('Signed in as ' + $('<span>').text(email).html() + ' · <a href="#" id="logout-link">Logout</a>');
            $('#logout-link').on('click', function(e){ e.preventDefault(); logout(); });
          } else {
            $as.html('<a href="#" id="show-login">Login</a> / <a href="#" id="show-register">Register</a>');
            $('#show-login').on('click', function(e){ e.preventDefault(); promptLogin(); });
            $('#show-register').on('click', function(e){ e.preventDefault(); promptRegister(); });
          }
        }

        function isApiAvailable(){
          return fetch('/api/health', { credentials: 'include' }).then(function(r){ return r.ok; }).catch(function(){ return false; });
        }

        function promptLogin(){
          var email = window.prompt('Email:');
          if (!email) return;
          var password = window.prompt('Password:');
          if (!password) return;
          fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email: email, password: password })
          }).then(function(r){ return r.json().then(function(j){ return { ok: r.ok, data: j }; }); })
            .then(function(res){
              if (!res.ok) { alert(res.data && res.data.error || 'Login failed'); return; }
              setAuthUI(email);
            }).catch(function(){ alert('Login failed'); });
        }

        function promptRegister(){
          var email = window.prompt('Email:');
          if (!email) return;
          var password = window.prompt('Password:');
          if (!password) return;
          fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ email: email, password: password })
          }).then(function(r){ return r.json().then(function(j){ return { ok: r.ok, data: j }; }); })
            .then(function(res){
              if (!res.ok) { alert(res.data && res.data.error || 'Register failed'); return; }
              setAuthUI(email);
            }).catch(function(){ alert('Register failed'); });
        }

        function logout(){
          fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }).finally(function(){ setAuthUI(null); });
        }

        function parseTags(input) {
          if (!input) return [];
          return input.split(',').map(function(x){ return x.trim(); }).filter(Boolean);
        }

        function loadAll() {
          var data = store.get(storageKey) || [];
          return Array.isArray(data) ? data : [];
        }

        function saveAll(arr) {
          store.set(storageKey, arr);
        }

        function refreshTable() {
          var $table = $('#saved-table');
          var $empty = $('#saved-empty');
          var $tbody = $table.find('tbody');
          $tbody.empty();

          // Try DB first
          isApiAvailable().then(function(ok){
            if (ok) {
              return fetch('/api/deadlines', { credentials: 'include' })
                .then(function(r){ return r.json().then(function(j){ return { ok: r.ok, data: j }; }); })
                .then(function(res){
                  if (!res.ok) throw new Error('not authed');
                  var data = Array.isArray(res.data) ? res.data : [];
                  if (data.length === 0) { $table.hide(); $empty.show(); return; }
                  $empty.hide();
                  $table.show();
                  data.forEach(function(item){
                    var tr = $('<tr>');
                    tr.append($('<td>').text(item.name || ''));
                    tr.append($('<td>').text(item.details || ''));
                    var whenText = item.datetime ? moment(item.datetime).format('YYYY-MM-DD HH:mm') : '';
                    tr.append($('<td>').text(whenText));
                    var tags = [];
                    try { tags = Array.isArray(item.tags) ? item.tags : JSON.parse(item.tags || '[]'); } catch(e) { tags = []; }
                    tr.append($('<td>').text(tags.join(', ')));
                    var delBtn = $('<button>', { class: 'btn btn-xs btn-danger' }).text('Delete').on('click', function(){
                      fetch('/api/deadlines/' + item.id, { method: 'DELETE', credentials: 'include' })
                        .then(function(){ refreshTable(); });
                    });
                    tr.append($('<td>').append(delBtn));
                    $tbody.append(tr);
                  });
                })
                .catch(function(){
                  // fallback to local below
                  renderLocal();
                });
            }
            // Fallback: local storage
            renderLocal();
          });

          function renderLocal(){
            var data = loadAll();
            if (data.length === 0) { $table.hide(); $empty.show(); return; }
            $empty.hide();
            $table.show();
            data.forEach(function(item, idx){
              var tr = $('<tr>');
              tr.append($('<td>').text(item.name || ''));
              tr.append($('<td>').text(item.details || ''));
              var whenText = item.datetime ? moment(item.datetime).format('YYYY-MM-DD HH:mm') : '';
              tr.append($('<td>').text(whenText));
              tr.append($('<td>').text((item.tags || []).join(', ')));
              var delBtn = $('<button>', { class: 'btn btn-xs btn-danger' }).text('Delete').on('click', function(){
                var all = loadAll();
                all.splice(idx, 1);
                saveAll(all);
                refreshTable();
              });
              tr.append($('<td>').append(delBtn));
              $tbody.append(tr);
            });
          }
        }

        $('#deadline-form').on('submit', function(e){
          e.preventDefault();
          var name = $('#name').val().trim();
          var details = $('#details').val().trim();
          var datetime = $('#datetime').val(); // datetime-local returns 'YYYY-MM-DDTHH:mm'
          var tags = parseTags($('#tags').val());
          if (!name || !datetime) {
            alert('Please enter name and deadline time.');
            return;
          }
          // Try API first
          isApiAvailable().then(function(ok){
            if (ok) {
              fetch('/api/deadlines', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ name: name, details: details, datetime: datetime, tags: tags })
              }).then(function(r){ return r.json().then(function(j){ return { ok: r.ok, data: j }; }); })
                .then(function(res){
                  if (!res.ok) throw new Error(res.data && res.data.error || 'Save failed');
                  $('#deadline-form')[0].reset();
                  refreshTable();
                }).catch(function(err){ alert(err.message || 'Save failed'); });
            } else {
              // Fallback to local storage
              var entries = loadAll();
              entries.push({ name: name, details: details, datetime: datetime, tags: tags });
              saveAll(entries);
              $('#deadline-form')[0].reset();
              refreshTable();
            }
          });
        });

        $('#clear-all').on('click', function(){
          if (confirm('This will remove all your saved deadlines in this browser. Continue?')) {
            saveAll([]);
            refreshTable();
          }
        });

        refreshTable();
        // Initialize auth UI optimistically (will show login/register unless cookie exists)
        setAuthUI(null);
      })();
    </script>
  </body>
  </html>


